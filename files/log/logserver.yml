---

# todo: on host-system
#   install docker-ce
#   install docker-compose
#   useradd --uid 472 grafana --system
#   useradd --uid 10001 loki
#   mkdir -p /var/lib/shieldwall/log/grafana/
#   mkdir -p /var/lib/shieldwall/log/loki/
#   chown grafana:grafana /var/lib/shieldwall/log/grafana/
#   chown loki:loki /var/lib/shieldwall/log/loki/

# todo: authentication

version: '3'

networks:
  loki:
    driver: bridge
    external: false
    ipam:
      driver: default
      config:
      - subnet: '192.168.0.0/29'

services:
  log-loki:
    image: 'grafana/loki:latest'
    ports:
      - '127.0.0.1:3100:3100'  # log input
    volumes:
      - '/etc/shieldwall/log_loki.yml:/etc/loki/local-config.yaml'
      - '/var/lib/shieldwall/log/loki:/loki'
    command: '-config.file=/etc/loki/local-config.yaml'
    networks:
      - loki
    restart: 'always'

  log-promtail:
    image: 'grafana/promtail:latest'
    volumes:
      - '/var/log/shieldwall:/var/log/shieldwall'
      - '/etc/shieldwall/log_promtail.yml:/etc/promtail/config.yml'
    command: '-config.file=/etc/promtail/config.yml'
    ports:
      - '127.0.0.1:10515:10515'  # syslog
      - '127.0.0.1:9080:9080'  # web-ui
    networks:
      - loki
    restart: 'always'

  log-grafana:
    image: 'grafana/grafana:latest'
    ports:
      - '3000:3000'  # grafana web-ui
    volumes:
      - '/etc/shieldwall/log_grafana.ini:/etc/grafana/grafana.ini'
      - '/var/lib/shieldwall/log/grafana:/var/lib/grafana'
      - '/etc/shieldwall/log_grafana.yml:/etc/grafana/provisioning/datasources/ds.yaml'
    environment:
      - 'GF_PATHS_CONFIG=/etc/grafana/grafana.ini'
      - 'GF_PATHS_DATA=/var/lib/grafana'
      - 'GF_PATHS_PROVISIONING=/etc/grafana/provisioning'
      - 'GF_AUTH_ANONYMOUS_ENABLED=true'
      - 'GF_AUTH_ANONYMOUS_ORG_ROLE=Admin'
    networks:
      - loki
    restart: 'always'
